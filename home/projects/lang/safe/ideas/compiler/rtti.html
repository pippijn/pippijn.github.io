<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"> 
	<head profile="http://www.w3.org/2005/10/profile"> 
		<title>Pippijn - Projects / Lang / Safe / Ideas / Compiler / Rtti</title> 
		<meta http-equiv="content-type" content="application/xhtml+xml; charset=utf-8"/> 
		<meta http-equiv="content-style-type" content="text/css"/> 
		<meta name="description" content="Pippijn van Steenhoven - Projects / Lang / Safe / Ideas / Compiler / Rtti"/> 
		<link rel="stylesheet" href="/home/css/home.css" type="text/css" title="Clean Blue" media="screen"/> 
		<link rel="icon" type="image/x-icon" href="/home/favicon.ico"/>
	</head> 

	<body> 
		<div id="header"> 
			<h1>Pippijn van Steenhoven</h1> 
			<p id="slogan">I doubt, therefore I might be</p> 
		</div> 

		<div id="sidebar"> 
			<h2>Menu</h2> 
			<div id="menubar">
				<ul>
  <li>
    <a href="/home/">Home</a>
  </li>
  <li>
    <a href="/home/projects">Projects
      <span class="small">[-]</span>
    </a>
    <ul>
      <li>
        <a href="/home/projects/devel">Developer tools
          <span class="small">[+]</span>
        </a>
      </li>
      <li>
        <a href="/home/projects/edu">Education
          <span class="small">[+]</span>
        </a>
      </li>
      <li>
        <a href="/home/projects/games">Games
          <span class="small">[+]</span>
        </a>
      </li>
      <li>
        <a href="/home/projects/net">Network
          <span class="small">[+]</span>
        </a>
      </li>
      <li>
        <a href="/home/projects/lang">Languages
          <span class="small">[-]</span>
        </a>
        <ul>
          <li>
            <a href="/home/projects/lang/aldor">Aldor
              <span class="small">[+]</span>
            </a>
          </li>
          <li>
            <a href="/home/projects/lang/ccparse">CParseParse
              <span class="small">[+]</span>
            </a>
          </li>
          <li>
            <a href="/home/projects/lang/cparser">C Parser
              <span class="small">[+]</span>
            </a>
          </li>
          <li>
            <a href="/home/projects/lang/glr">GLR Parser
              <span class="small">[+]</span>
            </a>
          </li>
          <li>
            <a href="/home/projects/lang/hm">Hindley-Milner
              <span class="small">[+]</span>
            </a>
          </li>
          <li>
            <a href="/home/projects/lang/jmlc">JML</a>
          </li>
          <li>
            <a href="/home/projects/lang/merr">Meta-Error</a>
          </li>
          <li>
            <a href="/home/projects/lang/re2ml">Re2ML</a>
          </li>
          <li>
            <a href="/home/projects/lang/libcdk">CDK library</a>
          </li>
          <li>
            <a href="/home/projects/lang/rasm">Runtime assembler</a>
          </li>
          <li>
            <a href="/home/projects/lang/safe">Safe C
              <span class="small">[-]</span>
            </a>
            <ul>
              <li>
                <a href="/home/projects/lang/safe/ideas">Future ideas
                  <span class="small">[-]</span>
                </a>
                <ul>
                  <li>
                    <a href="/home/projects/lang/safe/ideas/compiler">Compiler
                      <span class="small">[-]</span>
                    </a>
                    <ul>
                      <li>
                        <a href="/home/projects/lang/safe/ideas/compiler/bison">Bison</a>
                      </li>
                      <li>
                        <a href="/home/projects/lang/safe/ideas/compiler/colour">Colours</a>
                      </li>
                      <li>
                        <a href="/home/projects/lang/safe/ideas/compiler/const-rtti">Const RTTI</a>
                      </li>
                      <li>
                        <a href="/home/projects/lang/safe/ideas/compiler/inttypes">Integer types</a>
                      </li>
                      <li>
                        <a id="actmenu">RTTI</a>
                      </li>
                      <li>
                        <a href="/home/projects/lang/safe/ideas/compiler/s11n">Serialisation</a>
                      </li>
                      <li>
                        <a href="/home/projects/lang/safe/ideas/compiler/warnings">Warnings</a>
                      </li>
                    </ul>
                  </li>
                  <li>
                    <a href="/home/projects/lang/safe/ideas/language">Language
                      <span class="small">[+]</span>
                    </a>
                  </li>
                  <li>
                    <a href="/home/projects/lang/safe/ideas/runtime">Runtime
                      <span class="small">[+]</span>
                    </a>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
          <li>
            <a href="/home/projects/lang/treematch">Treematch
              <span class="small">[+]</span>
            </a>
          </li>
          <li>
            <a href="/home/projects/lang/xul">XUL Projects</a>
          </li>
          <li>
            <a href="/home/projects/lang/yaccpp">YACC Preprocessor</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="/home/projects/robotics">Robotics
          <span class="small">[+]</span>
        </a>
      </li>
      <li>
        <a href="/home/projects/system">Systems
          <span class="small">[+]</span>
        </a>
      </li>
    </ul>
  </li>
  <li>
    <a href="/home/opinions">Opinions
      <span class="small">[+]</span>
    </a>
  </li>
  <li>
    <a href="/home/programming">Programming
      <span class="small">[+]</span>
    </a>
  </li>
  <li>
    <a href="/home/links">Links</a>
  </li>
  <li>
    <a href="/home/contact">Contact</a>
  </li>
</ul>
			</div> 
		</div> 

		<div id="content">
			<h2>Runtime Type Information

</h2> <p>Generate runtime type info. e.g.:

</p> <h5>namespace info

</h5> <ul>
  <li>pointer to parent namespace (or NULL)
  
  </li>
  <li>name of namespace (or "" for global namespace (defined in runtime library))
  
  </li>
</ul> <h5>type info

</h5> <ul>
  <li>pointer to containing namespace
  
  </li>
  <li>name of type
  
  </li>
</ul> <h5>struct info (inherits type info)

</h5> <ul>
  <li>sizeof struct
  
  </li>
  <li>alignof struct (optional)
  
  </li>
  <li>array of members
  
  </li>
</ul> <h5>datatype info (inherits type info)

</h5> <ul>
  <li>array of constructors
  
  </li>
  <li>extensible flag (is this useful for anything?)
  
  </li>
</ul> <h5>constructor info

</h5> <ul>
  <li>name of constructor
  
  </li>
  <li>array of arguments (members)
  
  </li>
</ul> <h5>member info

</h5> <ul>
  <li>name of member
  
  </li>
  <li>pointer to type
  
  </li>
</ul> <p>All (some?) structs and datatypes will have an additional first member
pointing to their type info structure the problem with this is that they are
no longer compatible with C, because:

</p> <h3>alignment would always be at least alignof(pointer)

</h3> <p>Yes, this is a problem, because we can't just pass ptr + sizeof(pointer) to a
C functions.

</p> <p>This can be solved by doing something like

</p> <pre class="code-block"><span class="Type">struct</span> foo { <span class="Comment">// alignment=2 (x86)</span>
   <span class="Type">char</span> a;
   <span class="Type">short</span> b;
};</pre> <p>is compiled to:

</p> <pre class="code-block"><span class="Type">struct</span> foo_data { <span class="Comment">// alignment still 2</span>
   <span class="Type">char</span> a;
   <span class="Type">short</span> b;
};
<span class="Type">struct</span> foo { <span class="Comment">// alignment=4 (x86)</span>
   type_info <span class="Type">const</span> *ti;
   foo_data data;
};</pre> <p>and passing foo* to an extern C function looks like:

</p> <pre class="code-block">cfun (&amp;foo-&gt;data);</pre> <p>Similarly, a struct foo can be passed as 
  <code>cfun (foo.data)</code>.


</p> <p>Special care must be taken with casts. We support casting to supertypes. This
should retain the 
  <code>type_info</code> of the original struct, but if its pointee
is copied, the 
  <code>type_info</code> should be updated to reflect the supertype.


</p> <p>Luckily, there is no 
  <code>void*</code>, but 
  <code>`t</code> exists and this also needs
special thought, because rtti is most useful for generic functions. The
problem is that 
  <code>`t</code> can be non-pointer. Perhaps it is a good idea to forbid
non-pointers or introduce some kind of autoboxing for non-pointer types.

</p>
		</div> 

		<div id="footer"> 
			<div id="copyright"><a href="/home/contact">Copyright &copy; 2007-2013 Pippijn van Steenhoven</a></div> 
			<div id="updated">Last updated Mon Aug 12 02:40:39 MEST 2013</div> 
		</div> 
	</body> 
</html> 
